# Base compose file
# Contains all that is common between production and development configurations.
version: "3.7"

services:
  ui:
    container_name: biab-ui
    depends_on:
      - script-server
      - tiler

  # This can be accessed within the docker network with http://biab-script-server:8080/script/...
  script-server:
    container_name: biab-script-server
    volumes:
      - ${PIPELINE_REPO_PATH}/scripts:/scripts:ro
      - ./script-stubs:/scripts-stub:ro
      - ${PIPELINE_REPO_PATH}/pipelines:/pipelines:ro
      - ${PIPELINE_REPO_PATH}/userdata:/userdata:ro
      - ${PIPELINE_REPO_PATH}/output:/output:rw
      - /var/run/docker.sock:/var/run/docker.sock
    expose:
      - "8080"
    env_file:
      - ${PIPELINE_REPO_PATH}/runner.env
    environment:
      - SCRIPT_LOCATION=/scripts
      - SCRIPT_STUBS_LOCATION=/script-stubs
      - USERDATA_LOCATION=/userdata
      - PIPELINES_LOCATION=/pipelines
      - OUTPUT_LOCATION=/output
      - HOST_PATH=${PWD}
    depends_on:
      - runner-r
      - runner-julia

  runner-r:
    container_name: biab-runner-r
    volumes:
      - ${PIPELINE_REPO_PATH}/scripts:/scripts:ro
      - ${PIPELINE_REPO_PATH}/userdata:/userdata:ro
      - ${PIPELINE_REPO_PATH}/output:/output:rw
    env_file:
      - ${PIPELINE_REPO_PATH}/runner.env
    environment:
      - SCRIPT_LOCATION=/scripts
      - USERDATA_LOCATION=/userdata
      - OUTPUT_LOCATION=/output

  runner-julia:
    container_name: biab-runner-julia
    volumes:
      - ${PIPELINE_REPO_PATH}/scripts:/scripts:ro
      - ${PIPELINE_REPO_PATH}/userdata:/userdata:ro
      - ${PIPELINE_REPO_PATH}/output:/output:rw
    env_file:
      - ${PIPELINE_REPO_PATH}/runner.env
    environment:
      - SCRIPT_LOCATION=/scripts
      - USERDATA_LOCATION=/userdata
      - OUTPUT_LOCATION=/output

  http-gateway:
    container_name: http-rev-prox
    image: nginx
    ports:
      - "80:80"
    volumes:
      - /var/run/docker.sock:/tmp/docker.sock:ro
      - ${PIPELINE_REPO_PATH}/output:/static/output:ro
    depends_on:
      - script-server
      - ui

  tiler:
    container_name: biab-tiler
    image: ghcr.io/developmentseed/titiler:latest
    volumes:
      - ${PIPELINE_REPO_PATH}/output:/output:ro
      - ${PIPELINE_REPO_PATH}/userdata:/userdata:ro
    environment:
      - PORT=8000
      - WORKERS_PER_CORE=1
      - TITILER_API_CORS_ORIGINS=*
    extra_hosts:
      - "host.docker.internal:host-gateway"
